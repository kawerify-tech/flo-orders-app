rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if the user is the owner of a document based on email
    function isOwner(email) {
      return isSignedIn() && request.auth.token.email == email;
    }

    // Helper function to check if the user is an admin
    function isAdmin() {
      return isSignedIn() && request.auth.token.role == "admin";
    }

    // Helper function to check if the user is an attendant
    function isAttendant() {
      return isSignedIn() && exists(/databases/$(database)/documents/attendants/$(request.auth.uid));
    }

    function isValidEmail() {
      return request.auth.token.email.matches('^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$');
    }

    function isValidPhone() {
      return request.resource.data.phone.matches('^\\+?[1-9]\\d{1,14}$');
    }

    // General rule for signed-in users to access any collection (development)
    match /{collection}/{docId} {
      allow read, write: if isSignedIn();
    }

    // Admin rules - Admins can read/write everything
    match /admins/{docId} {
      allow read: if isAdmin();
      allow write: if isAdmin() && isValidEmail();
    }

    // Attendants can manage their own data or if they are an admin
    match /attendants/{attendantId} {
      allow read: if isSignedIn();
      allow create: if isAdmin() && isValidEmail() && isValidPhone();
      allow update: if isAttendant() && request.auth.uid == attendantId || isAdmin();
      allow delete: if isAdmin();
      
      // Attendant's transactions subcollection
      match /transactions/{transactionId} {
        allow read: if isAttendant() && request.auth.uid == attendantId || isAdmin();
        allow write: if isAttendant() && request.auth.uid == attendantId || isAdmin();
      }

      // Attendant's notifications subcollection
      match /notifications/{notificationId} {
        allow read: if isAttendant() && request.auth.uid == attendantId || isAdmin();
        allow create: if isAdmin();
        allow update: if isAttendant() && request.auth.uid == attendantId;
      }

      // Attendant's messages subcollection
      match /messages/{messageId} {
        allow read: if isAttendant() && request.auth.uid == attendantId || isAdmin();
        allow create: if isAttendant() && request.auth.uid == attendantId || isAdmin();
      }
    }

    // Client rules - Clients can access their own data
    match /clients/{clientId} {
      allow read: if isSignedIn() && (isOwner(clientId) || isAdmin() || isAttendant());
      allow create: if isAdmin() && isValidEmail() && isValidPhone();
      allow update: if isSignedIn() && (isOwner(clientId) || isAdmin());
      allow delete: if isAdmin();
      
      // Client's transactions subcollection
      match /transactions/{transactionId} {
        allow read: if isSignedIn() && (isOwner(clientId) || isAdmin() || isAttendant());
        allow create: if isSignedIn() && isOwner(clientId);
        allow update: if isAttendant() || isAdmin();
      }

      // Client's drafts subcollection
      match /drafts/{draftId} {
        allow read, write: if isSignedIn() && (isOwner(clientId) || isAdmin());
      }

      // Client's notifications subcollection
      match /notifications/{notificationId} {
        allow read: if isSignedIn() && (isOwner(clientId) || isAdmin());
        allow create: if isAdmin();
        allow update: if isSignedIn() && isOwner(clientId);
      }
    }

    // Global rules for transactions and notifications
    match /transactions/{transactionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isAttendant() || isAdmin();
      allow delete: if isAdmin();
    }

    match /notifications/{notificationId} {
      allow read: if isSignedIn();
      allow create: if isAdmin();
      allow update: if isSignedIn();
      allow delete: if isAdmin();
    }

    // Transaction updates validation function
    function isValidTransactionUpdate() {
      return request.resource.data.status in ['completed', 'rejected'] &&
             request.resource.data.attendantId == request.auth.uid;
    }

    // Apply the isValidTransactionUpdate check where appropriate (e.g., updating transaction status)
    match /transactions/{transactionId} {
      allow update: if isValidTransactionUpdate();
    }
  }
}
